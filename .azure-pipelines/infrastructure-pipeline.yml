# Azure DevOps Pipeline for Infrastructure Deployment Only
# Use this pipeline for deploying infrastructure changes independently

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - infra/*
      - .azure-pipelines/infrastructure-pipeline.yml

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - infra/*

variables:
  resourceGroupName: '$(Build.Repository.Name)-rg'
  azureSubscription: 'YOUR_AZURE_SERVICE_CONNECTION'  # Update with your Azure DevOps service connection name
  environmentName: 'dev'  # Change to 'staging' or 'prod' as needed

stages:
  - stage: ValidateBicep
    displayName: 'Validate Bicep Templates'
    jobs:
      - job: Validate
        displayName: 'Validate Infrastructure Code'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: AzureCLI@2
            displayName: 'Install Bicep CLI'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az bicep install
                az bicep version
          
          - task: AzureCLI@2
            displayName: 'Validate Bicep Templates'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Validating main.bicep..."
                az bicep build --file infra/main.bicep --outfile infra/main.json
                
                # Validate all module files
                find infra/modules -name "*.bicep" | while read file; do
                  echo "Validating $file..."
                  az bicep build --file "$file" || exit 1
                done
                
                echo "All Bicep templates validated successfully"
          
          - task: PublishTestResults@2
            displayName: 'Publish Validation Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: false
  
  - stage: DeployInfrastructure
    displayName: 'Deploy Infrastructure'
    dependsOn: ValidateBicep
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployInfra
        displayName: 'Deploy Bicep Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Create Resource Group (if not exists)'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az group create --name $(resourceGroupName) --location eastus || echo "Resource group already exists"
                
                - task: AzureCLI@2
                  displayName: 'Deploy Infrastructure'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Deploy using Bicep
                      az deployment group create \
                        --resource-group $(resourceGroupName) \
                        --template-file infra/main.bicep \
                        --parameters @infra/main.parameters.json \
                        --name "infra-deployment-$(Build.BuildId)" \
                        --verbose
                
                - task: AzureCLI@2
                  displayName: 'Export Deployment Outputs'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Get deployment outputs and save as pipeline variables
                      OUTPUTS=$(az deployment group show \
                        --resource-group $(resourceGroupName) \
                        --name "infra-deployment-$(Build.BuildId)" \
                        --query properties.outputs \
                        --output json)
                      
                      echo "##vso[task.setvariable variable=DeploymentOutputs]$OUTPUTS"

