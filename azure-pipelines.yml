# Azure DevOps CI/CD Pipeline for AI Document Processor
# This pipeline builds, tests, and deploys the Azure Functions application

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - pipeline/*
      - infra/*
      - azure-pipelines.yml
      - .azure-pipelines/*

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - pipeline/*
      - infra/*
      - azure-pipelines.yml

variables:
  pythonVersion: '3.11'
  functionAppName: '$(Build.Repository.Name)-function-app'
  resourceGroupName: '$(Build.Repository.Name)-rg'
  azureSubscription: 'YOUR_AZURE_SERVICE_CONNECTION'  # Update with your Azure DevOps service connection name
  environmentName: 'dev'  # Change to 'staging' or 'prod' as needed

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildFunctions
        displayName: 'Build Azure Functions'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true
              architecture: 'x64'
          
          - task: PythonScript@0
            displayName: 'Setup Python Environment'
            inputs:
              scriptSource: 'inline'
              script: |
                python -m pip install --upgrade pip
                pip install virtualenv
          
          - script: |
              python -m venv venv
              source venv/bin/activate
              pip install -r pipeline/requirements.txt
            displayName: 'Install Dependencies'
            workingDirectory: '$(System.DefaultWorkingDirectory)'
          
          - script: |
              source venv/bin/activate
              python -m pip install pylint pytest pytest-azurepipelines
              pylint pipeline/ --disable=C,R,W --output-format=text || true
            displayName: 'Run Linting'
            continueOnError: true
          
          - script: |
              source venv/bin/activate
              python -m pytest pipeline/ -v --junitxml=junit/test-results.xml || true
            displayName: 'Run Tests'
            continueOnError: true
          
          - task: ArchiveFiles@2
            displayName: 'Archive Function App'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/pipeline'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/functionapp.zip'
              replaceExistingArchive: true
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'functionapp'
              publishLocation: 'Container'
  
  - stage: ValidateInfrastructure
    displayName: 'Validate Bicep Templates'
    jobs:
      - job: ValidateBicep
        displayName: 'Validate Bicep Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: AzureCLI@2
            displayName: 'Validate Bicep Templates'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az bicep version
                az bicep build --file infra/main.bicep --outfile infra/main.json
                echo "Bicep templates validated successfully"
  
  - stage: DeployInfrastructure
    displayName: 'Deploy Infrastructure'
    dependsOn: ValidateInfrastructure
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployInfrastructure
        displayName: 'Deploy Azure Infrastructure'
        pool:
          vmImage: 'ubuntu-latest'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy Infrastructure with Bicep'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Deploy infrastructure using Azure Developer CLI (azd) or Bicep
                      # Option 1: Using azd (if azd is preferred)
                      # azd provision --environment $(environmentName)
                      
                      # Option 2: Using Bicep directly
                      az deployment group create \
                        --resource-group $(resourceGroupName) \
                        --template-file infra/main.bicep \
                        --parameters @infra/main.parameters.json \
                        --name "deployment-$(Build.BuildId)"
  
  - stage: DeployFunctions
    displayName: 'Deploy Azure Functions'
    dependsOn: [Build, DeployInfrastructure]
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployFunctions
        displayName: 'Deploy Function App'
        pool:
          vmImage: 'ubuntu-latest'
        environment: '$(environmentName)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@0
                  displayName: 'Download Build Artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'specific'
                    downloadPath: '$(System.ArtifactsDirectory)'
                    itemPattern: 'functionapp/functionapp.zip'
                
                - task: AzureFunctionApp@1
                  displayName: 'Deploy Azure Function App'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'functionApp'
                    appName: '$(functionAppName)'
                    package: '$(System.ArtifactsDirectory)/functionapp/functionapp.zip'
                    deploymentMethod: 'zipDeploy'
                
                - task: AzureCLI@2
                  displayName: 'Restart Function App'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az functionapp restart --name $(functionAppName) --resource-group $(resourceGroupName)

